!function(){angular.module("sp-peoplepicker",["pascalprecht.translate"]).directive("spPeoplePicker",["$q","$timeout","$compile","$translate",function(t,i,s,r){function o(e,s,o,n){t.when().then(function(){var e=t.defer();return i(function(){var t=o.value||n.$modelValue||n.$viewValue;t&&$("#hdnPeoplePick",s).val("string"==typeof t?t:JSON.stringify(t)),e.resolve()}),e.promise}).then(function(){function t(){var t=e.$root.$$phase;"$apply"!==t&&"$digest"!==t&&e.$apply()}function i(){var i=!0,s=!0;n.$viewValue&&(o.hasOwnProperty("minEntries")&&(i=n.$viewValue.length>=parseInt(e.minEntries,10)),o.hasOwnProperty("maxEntries")&&(s=n.$viewValue.length<=parseInt(e.maxEntries,10)));var r=i&&s;n.$setValidity("required",r),t()}e.peoplePicker.InstanceName="peoplePicker",e.peoplePicker.Language=r.use(),e.peoplePicker.MaxEntriesShown=e.maxEntries,e.peoplePicker.AllowDuplicates=e.allowDuplicates,e.peoplePicker.ShowLoginName=e.showLogin,e.peoplePicker.ShowTitle=e.showTitle,e.peoplePicker.OnSelectionChanged=function(){var e=JSON.parse($("#hdnPeoplePick",s).val());n.$setViewValue(e),n.$render(),t(),i()},e.peoplePicker.PrincipalType=SP.Utilities.PrincipalType.all,e.peoplePicker.MinimalCharactersBeforeSearching=e.minCharacters,e.peoplePicker.Initialize(),i()})}var n={link:o,restrict:"EA",require:"ngModel",replace:!0,scope:{minEntries:"@",maxEntries:"@",allowDuplicates:"@",showLogin:"=",showTitle:"=",minCharacters:"@",selections:"=",appWebUrl:"="},template:function(e,t){var i='<div class="cam-peoplepicker-input"><div id="divPeoplePick" class="cam-peoplepicker-userlookup ms-fullWidth"><span id="spanPeoplePick"></span><input type="text" id="inputPeoplePick" class="cam-peoplepicker-edit" /></div><div id="divPeoplePickSearch" class="cam-peoplepicker-usersearch ms-emphasisBorder"></div><input type="hidden" name="hdnPeoplePick" id="hdnPeoplePick" /></div>';return i},controller:["$scope","$element",function(t,i){t.spContext=new SP.ClientContext(t.appWebUrl);var r=new SP.ProxyWebRequestExecutorFactory(t.appWebUrl);t.spContext.set_webRequestExecutorFactory(r),t.peoplePicker=new e.PeoplePicker(t.spContext,$("#spanPeoplePick",i),$("#inputPeoplePick",i),$("#divPeoplePickSearch",i),$("#hdnPeoplePick",i)),t.peoplePicker.$scope=t,t.peoplePicker.$compile=s}]};return n}]);var e;!function(e){var t=function(){function e(e,t,i,s,r){this.SharePointContext=e,this.PeoplePickerControl=t,this.PeoplePickerEdit=i,this.PeoplePickerDisplay=s,this.PeoplePickerData=r,this.InstanceName="",this.MaxEntriesShown=4,this.ShowLoginName=!0,this.ShowTitle=!0,this.MinimalCharactersBeforeSearching=2,this.PrincipalType=1,this.AllowDuplicates=!1,this.Language="en-us",this.OnSelectionChanged=null,this._queryID=1,this._lastQueryID=1,this._ResolvedUsers=[],this.$scope=null,this.$compile=null}return e.prototype.GetPrincipalType=function(){return this.PrincipalType},e.prototype.SetPrincipalType=function(e){this.PrincipalType=e},e.prototype.GetMinimalCharactersBeforeSearching=function(){return this.MinimalCharactersBeforeSearching},e.prototype.SetMinimalCharactersBeforeSearching=function(e){this.MinimalCharactersBeforeSearching=e},e.prototype.HtmlEncode=function(e){return document.createElement("a").appendChild(document.createTextNode(e)).parentNode.innerHTML},e.prototype.HtmlDecode=function(e){var t=document.createElement("a");return t.innerHTML=e,t.textContent},String.prototype.ReplaceAll=function(e,t,i){var s,r=this+"",o=-1;if("string"==typeof e){if(!i)return this.split(e).join(t);for(s=e.toLowerCase();(o=r.toLowerCase().indexOf(e,o>=0?o+t.length:0))!==-1;)r=r.substring(0,o)+t+r.substring(o+e.length)}return r},e.prototype.LoadScript=function(e,t){var i=document.getElementsByTagName("head")[0],s=document.createElement("script");s.src=e;var r=!1;s.onload=s.onreadystatechange=function(){r||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(r=!0,t(),s.onload=s.onreadystatechange=null,i.removeChild(s))},i.appendChild(s)},e.prototype.Format=function(e){for(var t=1;t<arguments.length;t++)e=e.ReplaceAll("{"+(t-1)+"}",arguments[t]);return e},e.prototype.HideSelectionBox=function(){this.PeoplePickerDisplay.css("display","none")},e.prototype.ShowSelectionBox=function(){this.PeoplePickerDisplay.css("display","block")},e.prototype.ConstructResolvedUserSpan=function(e,t,i){return resultDisplay="Remove person or group {0}","undefined"!=typeof deleteUser&&(resultDisplay=deleteUser),lookupValue=e?e.replace("\\","\\\\"):i,resultDisplay=this.Format(resultDisplay,t),userDisplaySpanTemplate='<span class="cam-peoplepicker-userSpan"><span class="cam-entity-resolved">{0}</span><a title="{3}" class="cam-peoplepicker-delImage" ng-click="{1}.DeleteProcessedUser({2})" href>x</a></span>',this.Format(userDisplaySpanTemplate,t,this.InstanceName,"'"+lookupValue+"'",resultDisplay)},e.prototype.ResolvedUsersToHtml=function(){for(var e="",t=0;t<this._ResolvedUsers.length;t++)e+=this.ConstructResolvedUserSpan(this._ResolvedUsers[t].Login,this._ResolvedUsers[t].Name,this._ResolvedUsers[t].LookupId);return this.$compile(e)(this.$scope)},e.prototype.ResolvedUser=function(e,t,i,s){var r={};return r.Login=e,r.Name=t,r.Email=i,r.GroupId=s,r},e.prototype.PushResolvedUser=function(e){if(this.AllowDuplicates)this._ResolvedUsers.push(e);else{for(var t=!1,i=0;i<this._ResolvedUsers.length;i++)this._ResolvedUsers[i].Login==e.Login&&(t=!0);t||this._ResolvedUsers.push(e)}this.PeoplePickerData.val(JSON.stringify(this._ResolvedUsers))},e.prototype.PopResolvedUser=function(){this._ResolvedUsers.pop(),this.PeoplePickerData.val(JSON.stringify(this._ResolvedUsers))},e.prototype.RemoveResolvedUser=function(e){for(var t=[],i=0;i<this._ResolvedUsers.length;i++){var s=this._ResolvedUsers[i].Login?this._ResolvedUsers[i].Login:this._ResolvedUsers[i].LookupId;s!=e&&t.push(this._ResolvedUsers[i])}this._ResolvedUsers=t,this.PeoplePickerData.val(JSON.stringify(this._ResolvedUsers))},e.prototype.RecipientSelected=function(e,t,i,s){this.HideSelectionBox(),this.PushResolvedUser(this.ResolvedUser(e,t,i,s)),this.PeoplePickerControl.html(this.ResolvedUsersToHtml()),this.PeoplePickerEdit.val(""),this.PeoplePickerEdit.focus(),this.OnSelectionChanged()},e.prototype.DeleteProcessedUser=function(e){this.RemoveResolvedUser(e),this.PeoplePickerControl.html(this.ResolvedUsersToHtml()),this.PeoplePickerEdit.focus(),this.OnSelectionChanged()},e.prototype.QueryFailure=function(e){alert("Error performing user search")},e.prototype.QuerySuccess=function(e,t){var i=this.SharePointContext.parseObjectFromJsonString(t.get_value()),s="",r="<div class='ms-bgHoverable' style='width: 400px; padding: 4px;' ng-click='{0}.RecipientSelected(\"{1}\", \"{2}\", \"{3}\")'>{4}",o="";if(o=this.ShowLoginName&&this.ShowTitle?r+" ({5})<br/>{6}</div>":this.ShowLoginName||this.ShowTitle?r+" ({6})</div>":r+"</div>",i)if(i.length>0){if(e<this._lastQueryID)return;var n=i.length;n>this.MaxEntriesShown&&(n=this.MaxEntriesShown);for(var l=0;l<n;l++){var a=i[l],p=a.Key,c=a.DisplayText,h=a.EntityData.Title,u=a.EntityData.Email,d=a.EntityData.SPGroupID,P=u;if(p&&p.indexOf("|")>-1){var v=p.split("|");P=P+" "+v[v.length-1],P=P.trim()}s+=this.Format(o,this.InstanceName,p.replace("\\","\\\\"),this.HtmlEncode(c),u,c,P,h,d)}var f="";s+="<div class='ms-emphasisBorder' style='width: 400px; padding: 4px; border-left: none; border-bottom: none; border-right: none; cursor: default;'>",1==i.length?(f="Showing {0} result","undefined"!=typeof resultsSingle&&(f=resultsSingle),s+=this.Format(f,i.length)+"</div>"):n!=i.length?(f="Showing {0} of {1} results. <B>Please refine further<B/>","undefined"!=typeof resultsTooMany&&(f=resultsTooMany),s+=this.Format(f,n,i.length)+"</div>"):(f="Showing {0} results","undefined"!=typeof resultsMany&&(f=resultsMany),s+=this.Format(f,i.length)+"</div>"),this.PeoplePickerDisplay.html(this.$compile(s)(this.$scope)),this.ShowSelectionBox()}else{var m="<div class='ms-emphasisBorder' style='width: 400px; padding: 4px; border-left: none; border-bottom: none; border-right: none; cursor: default;'>No results found</div>";this.PeoplePickerDisplay.html(this.$compile(m)(this.$scope)),this.ShowSelectionBox()}else this.HideSelectionBox()},e.prototype.Initialize=function(){var e="",t="";$("script").each(function(i,s){s.src.toLowerCase().indexOf("sp-peoplepicker.js")>-1&&(e=s.src,t=e.substring(e.indexOf(".js")+3),e=e.substring(0,e.indexOf(".js")))});var i=e+"_resources."+this.Language.substring(0,2).toLowerCase()+".js";t.length>0&&(i+=t),this.LoadScript(i,function(){}),this.PeoplePickerData.val().length>0&&(this._ResolvedUsers=JSON.parse(this.PeoplePickerData.val()),this.PeoplePickerControl.html(this.ResolvedUsersToHtml()));var s=this;this.PeoplePickerControl.parent().click(function(e){s.PeoplePickerEdit.focus()}),this.PeoplePickerEdit.keydown(function(e){var t=e.which;if(8==t){s.HideSelectionBox();var i=s.PeoplePickerEdit.val();if(i.length>0);else if(s._ResolvedUsers.length>0)return s.PopResolvedUser(),s.PeoplePickerControl.html(s.ResolvedUsersToHtml()),s.PeoplePickerEdit.focus(),s.OnSelectionChanged(),!1}else if(t>=48&&t<=90||32==t){var r=s.PeoplePickerEdit.val();if(0==e.shiftKey&&t>=65&&t<=90&&(t+=32),r+=String.fromCharCode(t),r.length>0){var o=r;if(s.GetMinimalCharactersBeforeSearching()<1&&s.SetMinimalCharactersBeforeSearching(1),o.length>=s.GetMinimalCharactersBeforeSearching()){resultDisplay="Searching...","undefined"!=typeof resultsSearching&&(resultDisplay=resultsSearching);var n=s.Format("<div class='ms-emphasisBorder' style='width: 400px; padding: 4px; border-left: none; border-bottom: none; border-right: none; cursor: default;'>{0}</div>",resultDisplay);s.PeoplePickerDisplay.html(s.$compile(n)(s.$scope)),s.ShowSelectionBox();var l=new SP.UI.ApplicationPages.ClientPeoplePickerQueryParameters;l.set_allowMultipleEntities(!1),l.set_maximumEntitySuggestions(2e3),l.set_principalType(s.GetPrincipalType()),l.set_principalSource(15),l.set_queryString(o);var a=SP.UI.ApplicationPages.ClientPeoplePickerWebServiceInterface.clientPeoplePickerSearchUser(s.SharePointContext,l);s._queryID=s._queryID+1;var p=s._queryID;s._lastQueryID=p,s.SharePointContext.executeQueryAsync(Function.createDelegate(this,function(){s.QuerySuccess(p,a)}),Function.createDelegate(this,function(){s.QueryFailure(p)}))}}}else 9!=t&&27!=t||s.HideSelectionBox()})},e}();e.PeoplePicker=t}(e||(e={}))}();
